---
interface Heading {
  id: string;
  text: string;
  level: number;
}

interface Props {
  headings: Heading[];
}

const { headings } = Astro.props;
---

{
  headings.length > 0 && (
    <nav class="toc sticky top-8 space-y-1 text-sm">
      <p class="small-heading mb-3 text-foreground">Table of Contents</p>
      {headings.map((h) => (
        <a
          href={`#${h.id}`}
          data-toc-link={h.id}
          class:list={[
            "block rounded-sm text-foreground-muted no-underline transition-colors hover:text-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",
            h.level === 3 ? "pl-3" : h.level === 4 ? "pl-6" : "",
          ]}
        >
          {h.text}
        </a>
      ))}
    </nav>
  )
}

<script>
  const links = document.querySelectorAll<HTMLAnchorElement>("[data-toc-link]");
  const headingEls = [...links].map((l) =>
    document.getElementById(l.dataset.tocLink!),
  );

  const observer = new IntersectionObserver(
    (entries) => {
      entries.forEach((entry) => {
        const link = document.querySelector(
          `[data-toc-link="${entry.target.id}"]`,
        );
        if (entry.isIntersecting) {
          links.forEach((l) => l.classList.remove("is-active"));
          link?.classList.add("is-active");
        }
      });
    },
    { rootMargin: "0px 0px -80% 0px" },
  );

  headingEls.forEach((h) => h && observer.observe(h));
</script>
