---
import type { SanityDocument } from "@sanity/client";
import { sanityClient } from "sanity:client";
import Item from "@/components/Item.astro";
import Layout from "@/layouts/Layout.astro";

const APPEARANCES_QUERY = `*[
  _type == "appearance"
  && defined(slug.current)
]|order(publishedAt desc){_id, title, slug, publishedAt}`;

const appearances =
  await sanityClient.fetch<SanityDocument[]>(APPEARANCES_QUERY);

const appearancesByYear = appearances.reduce(
  (acc, appearance) => {
    const year = new Date(appearance.publishedAt).getFullYear();
    if (!acc[year]) {
      acc[year] = [];
    }
    acc[year].push(appearance);
    return acc;
  },
  {} as Record<number, SanityDocument[]>,
);

const years = Object.keys(appearancesByYear)
  .map(Number)
  .sort((a, b) => b - a);

const description =
  "A collection of my appearances on podcasts, talks, and other media";
---

<Layout title="Appearances â€” Ryan Furrer" description={description}>
  <div class="space-y-10">
    <!-- Dark panel header -->
    <header
      class="relative overflow-clip rounded-xl bg-[oklch(0.11_0_0)] px-6 py-8 dark:ring-1 dark:ring-white/5 sm:px-8 sm:py-10"
    >
      <div
        class="pointer-events-none absolute -right-8 -top-8 size-48 rounded-full blur-2xl"
        style="background: radial-gradient(circle, oklch(0.72 0.18 42 / 0.2), transparent 65%);"
        aria-hidden="true"
      ></div>
      <div class="relative">
        <h1 class="text-3xl font-bold tracking-tight text-white sm:text-4xl">
          Appearances<span class="text-rf-accent">.</span>
        </h1>
        <p class="mt-1 text-white/50">{description}</p>
      </div>
    </header>

    <!-- Year groups -->
    <main class="space-y-10">
      {
        years.map((year) => (
          <section class="space-y-4">
            <div class="flex items-center gap-2">
              <span class="size-2 rounded-full bg-rf-accent" aria-hidden="true" />
              <h2 class="font-mono text-sm font-semibold uppercase tracking-widest text-rf-accent">
                {year}
              </h2>
            </div>
            <ul class="grid grid-cols-1 gap-3 sm:grid-cols-2">
              {appearancesByYear[year].map((appearance) => (
                <li>
                  <Item
                    title={appearance.title}
                    href={`/appearances/${appearance.slug.current}`}
                    publishedAt={appearance.publishedAt}
                    variant="card"
                  />
                </li>
              ))}
            </ul>
          </section>
        ))
      }
    </main>
  </div>
</Layout>
