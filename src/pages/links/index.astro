---
import BlueskyIcon from "@/assets/icons/bluesky.svg";
import GithubIcon from "@/assets/icons/github.svg";
import LinkedinIcon from "@/assets/icons/linkedin2.svg";
import TwitchIcon from "@/assets/icons/twitch.svg";
import XIcon from "@/assets/icons/x.svg";
import YoutubeIcon from "@/assets/icons/youtube.svg";
import profilePicture from "@/assets/profile-picture.webp";
import LinksCard from "@/components/ui/LinksCard.astro";
import Layout from "@/layouts/Layout.astro";
import { cn } from "@/lib/utils";
import { urlForImage } from "@/sanity/lib/url-for-image";
import type { SanityDocument } from "@sanity/client";
import { sanityClient } from "sanity:client";
import { formatFollowerCount, getColorClasses } from "./utils";

const LATEST_CONTENT_QUERY = `{
  "post": *[_type == "post" && defined(slug.current)]|order(publishedAt desc)[0]{_id, title, slug, ogImage},
  "project": *[_type == "project" && defined(slug.current)]|order(publishedAt desc)[0]{_id, title, slug, ogImage},
  "appearance": *[_type == "appearance" && defined(slug.current)]|order(publishedAt desc)[0]{_id, title, slug, ogImage}
}`;

const latestContent = await sanityClient.fetch<{
  post: SanityDocument | null;
  project: SanityDocument | null;
  appearance: SanityDocument | null;
}>(LATEST_CONTENT_QUERY);

const {
  post: latestPost,
  project: latestProject,
  appearance: latestAppearance,
} = latestContent;

const getOgImageUrl = (item: SanityDocument | null) =>
  item?.ogImage ? urlForImage(item.ogImage).url() : undefined;

const latestPostOgImageUrl = getOgImageUrl(latestPost);
const latestProjectOgImageUrl = getOgImageUrl(latestProject);
const latestAppearanceOgImageUrl = getOgImageUrl(latestAppearance);

const latestContentItems = [
  {
    type: "writing",
    path: "writing",
    item: latestPost,
    ogImageUrl: latestPostOgImageUrl,
  },
  {
    type: "work",
    path: "work",
    item: latestProject,
    ogImageUrl: latestProjectOgImageUrl,
  },
  {
    type: "appearance",
    path: "appearances",
    item: latestAppearance,
    ogImageUrl: latestAppearanceOgImageUrl,
  },
].filter(
  (content): content is typeof content & { item: SanityDocument } =>
    content.item !== null,
);

const description = "A collection of links to my work, writing, and more";

const socialLinks = [
  {
    label: "Twitter/X",
    href: "https://x.com/ryandotfurrer",
    followerCount: 970,
    color: "zinc",
    icon: XIcon,
    iconFill: "fill-white",
    iconBackground: "bg-zinc-950",
    actionLabel: "Follow",
  },
  {
    label: "Bluesky",
    href: "https://bsky.app/profile/ryandotfurrer.bsky.social",
    followerCount: 764,
    color: "sky",
    icon: BlueskyIcon,
    iconFill: "fill-white",
    iconBackground: "bg-sky-500",
    actionLabel: "Follow",
  },
  {
    label: "Twitch",
    href: "https://www.twitch.tv/ryandotfurrer",
    followerCount: 178,
    color: "violet",
    icon: TwitchIcon,
    iconFill: "fill-white",
    iconBackground: "bg-violet-600",
    actionLabel: "Follow",
  },
  {
    label: "YouTube",
    href: "https://www.youtube.com/@ryandotfurrer",
    followerCount: 46,
    color: "rose",
    icon: YoutubeIcon,
    iconFill: "fill-white",
    iconBackground: "bg-rose-600",
    actionLabel: "Subscribe",
  },
  {
    label: "LinkedIn",
    href: "https://www.linkedin.com/in/ryanfurrer/",
    followerCount: 1920,
    color: "blue",
    icon: LinkedinIcon,
    iconFill: "fill-white stroke-none",
    iconBackground: "bg-blue-600",
    actionLabel: "Follow",
  },
  {
    label: "GitHub",
    href: "https://github.com/ryandotfurrer",
    followerCount: 59,
    color: "zinc",
    icon: GithubIcon,
    iconFill: "fill-white",
    iconBackground: "bg-zinc-950",
    actionLabel: "Follow",
  },
];
---

<Layout
  title="Links — Ryan Furrer"
  description={description}
  noNavbar
  noFooter
  maxWidth="sm"
>
  <div class="mx-auto w-full max-w-sm space-y-8">
    <!-- Dark profile panel -->
    <header
      class="relative overflow-clip rounded-2xl bg-[oklch(0.11_0_0)] px-6 py-8 dark:ring-1 dark:ring-white/5"
    >
      <!-- Glow blob -->
      <div
        class="pointer-events-none absolute -right-8 -top-8 size-48 rounded-full blur-2xl"
        style="background: radial-gradient(circle, oklch(0.72 0.18 285 / 0.25), transparent 65%);"
        aria-hidden="true"
      ></div>

      <div class="relative flex items-center gap-5">
        <!-- Avatar -->
        <div
          class="size-20 shrink-0 overflow-hidden rounded-full ring-2 ring-white/10"
        >
          <img
            src={profilePicture.src}
            alt="Ryan Furrer"
            width={profilePicture.width}
            height={profilePicture.height}
            class="h-full w-full object-cover"
          />
        </div>

        <!-- Name + bio -->
        <div>
          <h1 class="text-xl font-bold tracking-tight text-white">
            Ryan Furrer
          </h1>
          <p class="mt-0.5 text-sm leading-snug text-white/50">
            Frontend Engineer · Designer · Creator
          </p>
          <a
            href="/"
            class="no-underline mt-3 inline-block font-mono text-xs font-semibold uppercase tracking-widest text-rf-accent transition-colors hover:text-white/60"
          >
            ryanfurrer.com →
          </a>
        </div>
      </div>
    </header>

    <main class="space-y-10">
      <!-- Connect section -->
      <section class="space-y-4">
        <div class="flex items-center gap-3">
          <h2 class="small-heading shrink-0 text-rf-accent">Connect with me</h2>
          <div class="h-px flex-1 bg-border"></div>
        </div>
        <div class="grid grid-cols-2 gap-4">
          {
            socialLinks.map((link) => {
              const IconComponent = link.icon;
              return (
                <LinksCard
                  href={link.href}
                  variant="square"
                  class={getColorClasses(link.color)}
                >
                  <div class="flex h-full flex-col justify-between">
                    <div class="flex flex-col gap-2">
                      <IconComponent
                        class:list={[
                          "squircle size-8 rounded-xl p-2",
                          link.iconFill,
                          link.iconBackground,
                        ]}
                      />
                      <h3 class="small-heading leading-none">{link.label}</h3>
                    </div>
                    <div
                      class={cn(
                        getColorClasses(link.color),
                        "font-mono-custom mt-1 bg-transparent! text-4xl dark:text-white!",
                      )}
                    >
                      <span>{formatFollowerCount(link.followerCount)}</span>
                    </div>
                    <div>
                      <span
                        class={cn(
                          "squircle pointer-events-none inline-flex h-auto items-center justify-center rounded-lg px-2 py-1 text-xs font-medium text-inherit transition-colors focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:outline-none disabled:pointer-events-none disabled:opacity-50",
                          getColorClasses(link.color),
                        )}
                      >
                        {link.actionLabel}
                      </span>
                    </div>
                  </div>
                </LinksCard>
              );
            })
          }
        </div>
      </section>

      <!-- Latest work section -->
      {
        latestContentItems.length > 0 && (
          <section class="space-y-4">
            <div class="flex items-center gap-3">
              <h2 class="small-heading shrink-0 text-rf-accent">My Latest Work</h2>
              <div class="h-px flex-1 bg-border"></div>
            </div>
            <div class="grid grid-cols-1 gap-4">
              {latestContentItems.map((content) => (
                <LinksCard
                  href={`/${content.path}/${content.item.slug.current}`}
                >
                  <header class="flex items-center pt-1 pb-2">
                    <p class="small-heading leading-none">{content.type}</p>
                    <h3 class="sr-only">{content.item.title}</h3>
                  </header>
                  {content.ogImageUrl && (
                    <div class="overflow-hidden rounded-md">
                      <img
                        src={content.ogImageUrl}
                        alt={content.item.title}
                        loading="lazy"
                      />
                    </div>
                  )}
                </LinksCard>
              ))}
            </div>
          </section>
        )
      }
    </main>
  </div>
</Layout>
