---
import type { SanityDocument } from "@sanity/client";
import { sanityClient } from "sanity:client";
import Item from "@/components/Item.astro";
import Layout from "@/layouts/Layout.astro";

const PROJECTS_QUERY = `*[
  _type == "project"
  && defined(slug.current)
]|order(publishedAt desc){_id, title, slug, publishedAt, techStack}`;

const projects = await sanityClient.fetch<SanityDocument[]>(PROJECTS_QUERY);

const projectsByYear = projects.reduce(
  (acc, project) => {
    const year = new Date(project.publishedAt).getFullYear();
    if (!acc[year]) {
      acc[year] = [];
    }
    acc[year].push(project);
    return acc;
  },
  {} as Record<number, SanityDocument[]>,
);

const years = Object.keys(projectsByYear)
  .map(Number)
  .sort((a, b) => b - a);

const description = "A collection of my projects, code snippets, and more";
---

<Layout title="Work â€” Ryan Furrer" description={description}>
  <div class="space-y-10">
    <header class="border-b border-border pb-10">
      <div class="hero-animate mb-6 flex items-center gap-3">
        <div class="size-1.5 rounded-full bg-rf-accent shrink-0"></div>
        <div class="h-px flex-1 bg-border"></div>
      </div>
      <h1
        class="hero-animate hero-delay-1 font-serif italic text-foreground leading-none"
        style="font-size: clamp(3rem, 9vw, 6rem);"
      >
        Work<span class="text-rf-accent">.</span>
      </h1>
      <p class="hero-animate hero-delay-2 mt-4 font-mono text-sm text-foreground-muted tracking-wide">
        {description}
      </p>
    </header>

    <!-- Year groups -->
    <main class="space-y-10">
      {
        years.map((year) => (
          <section class="space-y-4">
            <h2 class="font-mono-custom text-foreground-muted">
              {year}
            </h2>
            <ul class="grid grid-cols-1 gap-3 sm:grid-cols-2">
              {projectsByYear[year].map((project) => (
                <li>
                  <Item
                    title={project.title}
                    href={`/work/${project.slug.current}`}
                    techStack={project.techStack}
                    variant="card"
                  />
                </li>
              ))}
            </ul>
          </section>
        ))
      }
    </main>
  </div>
</Layout>
