---
import type { SanityDocument } from "@sanity/client";
import { sanityClient } from "sanity:client";
import Item from "../../components/Item.astro";
import Layout from "../../layouts/Layout.astro";

const PROJECTS_QUERY = `*[
  _type == "project"
  && defined(slug.current)
]|order(publishedAt desc){_id, title, slug, publishedAt, techStack}`;

const projects = await sanityClient.fetch<SanityDocument[]>(PROJECTS_QUERY);

// Group projects by year
const projectsByYear = projects.reduce(
  (acc, project) => {
    const year = new Date(project.publishedAt).getFullYear();
    if (!acc[year]) {
      acc[year] = [];
    }
    acc[year].push(project);
    return acc;
  },
  {} as Record<number, SanityDocument[]>,
);

// Sort years descending (newest first)
const years = Object.keys(projectsByYear)
  .map(Number)
  .sort((a, b) => b - a);
---

<Layout>
  <div class="space-y-8">
    <header class="md:px-2">
      <h1>Projects</h1>
    </header>
    <main>
      <div class="space-y-8">
        {
          years.map((year) => (
            <section class="space-y-4">
              <h2 class="custom-font-mono md:px-2">{year}</h2>
              <ul class="flex flex-col gap-px">
                {projectsByYear[year].map((project) => (
                  <li>
                    <Item
                      title={project.title}
                      href={`/projects/${project.slug.current}`}
                      techStack={project.techStack}
                    />
                  </li>
                ))}
              </ul>
            </section>
          ))
        }
      </div>
    </main>
  </div>
</Layout>
